<!DOCTYPE html>
<html>
<head>
    <title>Web Resep & Admin Panel</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; background-color: #f4f4f4; }
        .halaman { display: none; } 
        .aktif { display: block; }  
        .container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        input { display: block; width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; cursor: pointer; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 16px; margin-top: 10px; }
        
        .btn-blue { background: #007bff; }
        .btn-red { background: #dc3545; }
        .btn-orange { background: #fd7e14; }
        
        .card { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; display: flex; gap: 15px; border-radius: 8px; background: #fff; align-items: center; }
        .link { color: #007bff; cursor: pointer; text-decoration: underline; }
        
        /* STYLE KHUSUS TABEL ADMIN */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }

        /* Popup Detail */
        #detail-area { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; background: white; padding: 20px; border: 2px solid #28a745; z-index: 1000; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
    </style>
</head>
<body>
    <div id="overlay" onclick="tutupDetail()"></div>

    <div class="container">
        <div id="page-register" class="halaman aktif">
            <h1>Daftar Akun</h1>
            <input type="email" id="reg-email" placeholder="Email">
            <input type="password" id="reg-pass" placeholder="Password">
            <button onclick="doRegister()">Daftar</button>
            <div id="api-key-result" style="display:none; background: #e2e3e5; padding: 10px; margin-top: 10px;">
                <p>Copy API Key ini:</p>
                <b id="text-apikey" style="color:red; font-size: 1.2em;"></b>
                <br>
                <button class="btn-blue" onclick="keHalaman('page-login')">Ke Login</button>
            </div>
            <p>Sudah punya akun? <span class="link" onclick="keHalaman('page-login')">Login</span></p>
        </div>

        <div id="page-login" class="halaman">
            <h1>Login</h1>
            <p>Masukkan Email, Password, dan <b>API Key</b>.</p>
            <input type="email" id="login-email" placeholder="Email">
            <input type="password" id="login-pass" placeholder="Password">
            <input type="text" id="login-apikey" placeholder="Paste API Key disini..." style="border: 2px solid #007bff;">
            
            <button class="btn-blue" onclick="doLogin()">Masuk</button>
            <p>Belum punya akun? <span class="link" onclick="keHalaman('page-register')">Daftar</span></p>
        </div>

        <div id="page-dashboard" class="halaman">
            <div style="display:flex; justify-content:space-between;">
                <h3>Dashboard Resep</h3>
                <button class="btn-red" onclick="doLogout()">Logout</button>
            </div>
            <p>Selamat datang, User!</p>
            <input type="text" id="keyword" placeholder="Cari resep (misal: Nasi Goreng)">
            <button onclick="cariResep()">Cari</button>
            <div id="hasil" style="margin-top: 20px;"></div>
        </div>

        <div id="page-admin" class="halaman">
            <div style="display:flex; justify-content:space-between; background: #333; color: white; padding: 10px; border-radius: 5px;">
                <h3 style="margin:0;">ADMIN PANEL</h3>
                <button class="btn-red" onclick="doLogout()">Logout</button>
            </div>
            
            <p>Berikut adalah daftar user yang terdaftar di sistem:</p>
            <button class="btn-orange" onclick="loadDataUser()">ðŸ”„ Refresh Data User</button>

            <thead>
                <table id="tabel-user">
                    <tr>
                        <th>ID</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>API Key</th>
                    </tr>
                    </table>
            </thead>
        </div>
    </div>

    <div id="detail-area">
        <h2 id="judul-detail"></h2>
        <img id="gambar-detail" width="100%">
        <div id="instruksi"></div>
        <button class="btn-red" onclick="tutupDetail()">Tutup</button>
    </div>

    <script>
        let CURRENT_API_KEY = ''; 
        const BASE_URL = 'http://localhost:3000';

        function keHalaman(id) {
            document.querySelectorAll('.halaman').forEach(el => el.classList.remove('aktif'));
            document.getElementById(id).classList.add('aktif');
        }

        // --- FUNGSI LOGIN (SUDAH DI-UPGRADE) ---
        async function doLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-pass').value;
            const apiKey = document.getElementById('login-apikey').value;

            const res = await fetch(`${BASE_URL}/api/auth/login`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password, apiKey })
            });
            const data = await res.json();
            
            if(data.status === 'sukses') {
                CURRENT_API_KEY = data.user.api_key; // Simpan kunci
                
                // --- LOGIKA PEMISAH (USER vs ADMIN) ---
                if (data.user.role === 'admin') {
                    // Kalau Admin -> Masuk ke Halaman Admin & Load Data User
                    keHalaman('page-admin');
                    loadDataUser(); 
                } else {
                    // Kalau User Biasa -> Masuk ke Halaman Resep
                    keHalaman('page-dashboard');
                }

            } else { alert(data.pesan); }
        }

        // --- FUNGSI KHUSUS ADMIN: LOAD DATA USER ---
        async function loadDataUser() {
            // Kita pakai API Key Admin buat request data rahasia ini
            const res = await fetch(`${BASE_URL}/api/admin/users`, {
                headers: { 'x-api-key': CURRENT_API_KEY } 
            });

            if (res.status === 403) {
                alert("Anda bukan Admin!"); return;
            }

            const data = await res.json();
            const tabel = document.getElementById('tabel-user');
            
            // Reset tabel (sisakan header)
            tabel.innerHTML = `<tr><th>ID</th><th>Email</th><th>Role</th><th>API Key</th></tr>`;

            data.data.forEach(u => {
                tabel.innerHTML += `
                    <tr>
                        <td>${u.id}</td>
                        <td>${u.email}</td>
                        <td><b>${u.role}</b></td>
                        <td style="font-family:monospace; color:red;">${u.api_key}</td>
                    </tr>
                `;
            });
        }

        // --- REGISTER USER ---
        async function doRegister() {
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-pass').value;
            const res = await fetch(`${BASE_URL}/api/auth/register`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            if(data.data) {
                document.getElementById('api-key-result').style.display = 'block';
                document.getElementById('text-apikey').innerText = data.data.apiKey;
            } else { alert(data.pesan); }
        }

        // --- CARI RESEP ---
        async function cariResep() {
            const keyword = document.getElementById('keyword').value;
            const res = await fetch(`${BASE_URL}/api/cari-resep?keyword=${keyword}`, {
                headers: { 'x-api-key': CURRENT_API_KEY }
            });
            const data = await res.json();
            const kotak = document.getElementById('hasil');
            kotak.innerHTML = '';
            if(data.results) {
                data.results.forEach(r => {
                    kotak.innerHTML += `<div class="card">
                        <img src="${r.image}" width="80">
                        <div><b>${r.title}</b><br><button class="btn-blue" onclick="lihatDetail(${r.id})">Lihat</button></div>
                    </div>`;
                });
            }
        }

        function doLogout() { CURRENT_API_KEY = ''; keHalaman('page-login'); }

        async function lihatDetail(id) {
            const res = await fetch(`${BASE_URL}/api/detail-resep/${id}`, { headers: { 'x-api-key': CURRENT_API_KEY } });
            const data = await res.json();
            document.getElementById('judul-detail').innerText = data.title;
            document.getElementById('gambar-detail').src = data.image;
            document.getElementById('instruksi').innerHTML = data.instructions || "Gak ada instruksi";
            document.getElementById('detail-area').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function tutupDetail() {
            document.getElementById('detail-area').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
    </script>
</body>
</html>